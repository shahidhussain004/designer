# Custom Element Scoping

## Problem

A limitation of the Custom Elements standard is that there is only a single, global `CustomElementRegistry`. If two libraries (or two versions of the same library) define a custom element with the same tag name, only one registration can succeed — the other will throw an error because the name is already taken.

In micro-frontend environments this is problematic: multiple independently-deployed apps may load different versions of Green Core on the same page.

## Proposed Browser Solution

There is a proposal for Scoped Custom Element Registries that would allow user-instantiated registries scoped to a `ShadowRoot`. See the proposal:

https://github.com/WICG/webcomponents/blob/gh-pages/proposals/Scoped-Custom-Element-Registries.md

This is not yet widely available in stable browsers (as of mid-2023 it exists behind flags in Chrome Canary).

## Green Core Solution

To make Green Core robust in micro-frontend scenarios we implement an internal scoping mechanism with the following properties:

1. **Version-suffixed element names**: Each element gets a deterministic version suffix. For example `gds-popover` becomes `gds-popover-<versionstring>`. The `versionstring` is generated by hashing the Green Core package source code for the release.

2. **Custom registration decorator**: `@gdsCustomElement` registers elements by automatically appending the version suffix and adding the registration to an internal lookup table. If the element name is already present in the lookup table, registration aborts silently (assumed to be the same version already loaded).

3. **Template rewriting**: A custom HTML template tag rewrites tag names in templates to include the version suffix before passing them to Lit's `html` tag. A template tag factory is also provided for consumers that need a custom tag.

4. **React / Angular wrappers**: Wrappers add the appropriate suffix automatically so consumers don't need to manually adjust tag names when using framework wrappers.

## Behavior Details

- If two different versions of Green Core are loaded, both may register the same logical component name with different suffixed names (e.g. `gds-popover-x` and `gds-popover-y`). Both will coexist without collisions.
- If the same version of Green Core is loaded twice, the second registration is a no-op (silently ignored) which avoids throwing errors and allows safe reuse.
- Consumers using plain HTML (static templates, non-template languages) will need to include the suffix manually, or disable scoping. This is an edge-case and not recommended for typical usage.

## Caveats

- **Hard-coded HTML usage**: If a consumer uses hard-coded HTML that cannot use template tags, they may need to include the version suffix manually or ensure only a single Green Core version is loaded.
- **Non-Lit consumers**: A template tag factory is provided for non-Lit consumers, but the flow may require runtime integration.
- **Future migration**: When browser support for scoped registries becomes ubiquitous, the scoping mechanism can be removed in favor of native scoped registries.

## Recommendation

- Prefer consuming Green Core via the React or Angular wrappers which handle scoping automatically.
- When using web components directly prefer template-tag usage to ensure tags are rewritten automatically.
- Use scoping only where necessary; provide a toggle to disable scoping for specific deployments if required.

## Implementation notes

- Version string generation must be deterministic and stable across builds for the same package version.
- The decorator and lookup table must be lightweight to avoid runtime overhead.
- Provide dev-mode diagnostics to surface scoping mismatches during integration testing.

## Related docs

- [Green Design System Architecture](./GreenDesignSystemArchitecture.md)
- [Green Core Declarative Layout](./GreenCoreDeclarativeLayout.md)
- [Code Splitting](./CodeSplitting.md) — Pure component imports and tree-shaking for optimal bundle size
- [Code Conventions](./CodeConventions.md) — Naming conventions and component registration patterns
