name: Publish Java image to GHCR

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for Java project
        id: check_project
        run: |
          if [ -f "pom.xml" ]; then
            echo "has_java_project=true" >> $GITHUB_OUTPUT
            echo "âœ“ Java project found (pom.xml)"
          else
            echo "has_java_project=false" >> $GITHUB_OUTPUT
            echo "âš  No Java project found - skipping Maven build"
          fi

      - name: Set up JDK 17
        if: steps.check_project.outputs.has_java_project == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin

      - name: Cache Maven packages
        if: steps.check_project.outputs.has_java_project == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build JAR (Maven)
        if: steps.check_project.outputs.has_java_project == 'true'
        run: mvn -B -DskipTests package

      - name: Check for Dockerfile
        id: check_dockerfile
        run: |
          if [ -f "Dockerfile" ]; then
            echo "has_dockerfile=true" >> $GITHUB_OUTPUT
            echo "âœ“ Dockerfile found"
          else
            echo "has_dockerfile=false" >> $GITHUB_OUTPUT
            echo "âš  No Dockerfile found - skipping Docker build"
          fi

      - name: Log in to GitHub Container Registry
        if: steps.check_dockerfile.outputs.has_dockerfile == 'true'
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        if: steps.check_dockerfile.outputs.has_dockerfile == 'true'
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest

      - name: Verify image in GHCR
        if: steps.check_dockerfile.outputs.has_dockerfile == 'true'
        run: |
          echo "Image pushed to ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest"

      - name: Summary
        run: |
          echo "ðŸ“Š CI/CD Summary"
          echo "Java Project: ${{ steps.check_project.outputs.has_java_project }}"
          echo "Dockerfile: ${{ steps.check_dockerfile.outputs.has_dockerfile }}"
