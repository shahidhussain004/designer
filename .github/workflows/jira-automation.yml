name: Jira Automation - Ticket Status Transitions

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, converted_to_draft, labeled]
  push:
    branches: [main, develop]
  issues:
    types: [opened, labeled]

permissions:
  pull-requests: write
  contents: read

env:
  JIRA_DOMAIN: designercompk
  JIRA_PROJECT: KAN

jobs:
  extract-ticket:
    name: Extract Jira Ticket from Branch/PR
    runs-on: ubuntu-latest
    outputs:
      ticket_key: ${{ steps.extract.outputs.ticket_key }}
      ticket_found: ${{ steps.extract.outputs.ticket_found }}
      event_type: ${{ steps.detect_event.outputs.event_type }}
    steps:
      - name: Detect event type
        id: detect_event
        run: |
          EVENT="${{ github.event_name }}"
          ACTION="${{ github.event.action }}"
          echo "Event: $EVENT, Action: $ACTION"
          echo "event_type=$EVENT" >> $GITHUB_OUTPUT

      - name: Extract ticket from branch name
        id: extract
        run: |
          # Extract from branch name (e.g., feature/KAN-43-user-auth)
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          echo "Branch: $BRANCH_NAME"
          
          # Try to match KAN-XX pattern
          if [[ $BRANCH_NAME =~ (KAN-[0-9]+) ]]; then
            TICKET="${BASH_REMATCH[1]}"
            echo "‚úì Found ticket: $TICKET"
            echo "ticket_key=$TICKET" >> $GITHUB_OUTPUT
            echo "ticket_found=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö† No ticket found in branch name"
            echo "ticket_found=false" >> $GITHUB_OUTPUT
          fi

  on-pr-opened:
    name: Move to In Review (PR Opened)
    needs: extract-ticket
    if: needs.extract-ticket.outputs.ticket_found == 'true' && github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'synchronize')
    runs-on: ubuntu-latest
    steps:
      - name: Debug Info
        run: |
          echo "üîç PR Event Debug"
          echo "Event: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"
          echo "Ticket: ${{ needs.extract-ticket.outputs.ticket_key }}"
          echo "Ticket Found: ${{ needs.extract-ticket.outputs.ticket_found }}"

      - name: Transition ticket to In Review
        env:
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_EMAIL: shahidhussain004@gmail.com
          TICKET_KEY: ${{ needs.extract-ticket.outputs.ticket_key }}
        run: |
          echo "üîÑ Moving $TICKET_KEY to In Review..."
          if [ -z "$JIRA_API_TOKEN" ]; then
            echo "‚ùå JIRA_API_TOKEN is not set!"
            exit 1
          fi
          AUTH=$(echo -n "$JIRA_EMAIL:$JIRA_API_TOKEN" | base64)
          RESPONSE=$(curl -X POST \
            -H "Authorization: Basic $AUTH" \
            -H "Content-Type: application/json" \
            -d '{"transition":{"id":"31"}}' \
            "https://$JIRA_DOMAIN.atlassian.net/rest/api/3/issue/$TICKET_KEY/transitions" \
            -w '\nHTTP_CODE:%{http_code}')
          echo "$RESPONSE"
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE" | cut -d':' -f2)
          if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Successfully moved $TICKET_KEY to In Review"
          else
            echo "‚ö† Failed to transition. HTTP Status: $HTTP_CODE"
            exit 1
          fi

  on-labeled-test:
    name: Move to In Test (Test Label Added)
    needs: extract-ticket
    if: needs.extract-ticket.outputs.ticket_found == 'true' && (github.event_name == 'pull_request' && github.event.action == 'labeled' && github.event.label.name == 'test')
    runs-on: ubuntu-latest
    steps:
      - name: Debug Info
        run: |
          echo "üîç Label Event Debug"
          echo "Event: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"
          echo "Label: ${{ github.event.label.name }}"
          echo "Ticket: ${{ needs.extract-ticket.outputs.ticket_key }}"

      - name: Transition ticket to In Test
        env:
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_EMAIL: shahidhussain004@gmail.com
          TICKET_KEY: ${{ needs.extract-ticket.outputs.ticket_key }}
        run: |
          echo "üß™ Moving $TICKET_KEY to In Test..."
          if [ -z "$JIRA_API_TOKEN" ]; then
            echo "‚ùå JIRA_API_TOKEN is not set!"
            exit 1
          fi
          AUTH=$(echo -n "$JIRA_EMAIL:$JIRA_API_TOKEN" | base64)
          RESPONSE=$(curl -X POST \
            -H "Authorization: Basic $AUTH" \
            -H "Content-Type: application/json" \
            -d '{"transition":{"id":"41"}}' \
            "https://$JIRA_DOMAIN.atlassian.net/rest/api/3/issue/$TICKET_KEY/transitions" \
            -w '\nHTTP_CODE:%{http_code}')
          echo "$RESPONSE"
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE" | cut -d':' -f2)
          if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Successfully moved $TICKET_KEY to In Test"
          else
            echo "‚ö† Failed to transition. HTTP Status: $HTTP_CODE"
            exit 1
          fi
          fi

  on-pr-merged:
    name: Move to Done (PR Merged to Main)
    needs: extract-ticket
    if: needs.extract-ticket.outputs.ticket_found == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Debug Info
        run: |
          echo "üîç Push/Merge Event Debug"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Commit Message: ${{ github.event.head_commit.message }}"
          echo "Ticket: ${{ needs.extract-ticket.outputs.ticket_key }}"

      - name: Transition ticket to Done
        env:
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_EMAIL: shahidhussain004@gmail.com
          TICKET_KEY: ${{ needs.extract-ticket.outputs.ticket_key }}
        run: |
          echo "‚úÖ Moving $TICKET_KEY to Done..."
          if [ -z "$JIRA_API_TOKEN" ]; then
            echo "‚ùå JIRA_API_TOKEN is not set!"
            exit 1
          fi
          AUTH=$(echo -n "$JIRA_EMAIL:$JIRA_API_TOKEN" | base64)
          RESPONSE=$(curl -X POST \
            -H "Authorization: Basic $AUTH" \
            -H "Content-Type: application/json" \
            -d '{"transition":{"id":"51"}}' \
            "https://$JIRA_DOMAIN.atlassian.net/rest/api/3/issue/$TICKET_KEY/transitions" \
            -w '\nHTTP_CODE:%{http_code}')
          echo "$RESPONSE"
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE" | cut -d':' -f2)
          if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Successfully moved $TICKET_KEY to Done"
          else
            echo "‚ö† Failed to transition. HTTP Status: $HTTP_CODE"
            exit 1
          fi

  update-pr-description:
    name: Add Jira Link to PR
    needs: extract-ticket
    if: needs.extract-ticket.outputs.ticket_found == 'true' && github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'synchronize')
    runs-on: ubuntu-latest
    steps:
      - name: Debug Info
        run: |
          echo "üîç PR Description Update Debug"
          echo "Ticket: ${{ needs.extract-ticket.outputs.ticket_key }}"
          echo "PR Number: ${{ github.event.number }}"

      - name: Update PR with Jira link
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            try {
              const ticket = '${{ needs.extract-ticket.outputs.ticket_key }}';
              const jiraLink = `https://designercompk.atlassian.net/browse/${ticket}`;
              const body = context.payload.pull_request.body || '';
              
              console.log(`üìù Attempting to add Jira link to PR #${context.issue.number}`);
              console.log(`Ticket: ${ticket}`);
              console.log(`Current body length: ${body.length}`);
              
              if (!body.includes(jiraLink)) {
                const newBody = `${body}\n\n---\n**Jira Ticket:** [${ticket}](${jiraLink})`;
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  body: newBody
                });
                console.log(`‚úÖ Added Jira link to PR: ${jiraLink}`);
              } else {
                console.log(`‚Ñπ Jira link already present in PR description`);
              }
            } catch (error) {
              console.log(`‚ö† Could not update PR (may lack permissions): ${error.message}`);
              console.log(`‚Ñπ Jira Link: https://designercompk.atlassian.net/browse/${{ needs.extract-ticket.outputs.ticket_key }}`);
            }

  post-merge-comment:
    name: Post Merge Comment with Deployment Info
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Debug Info
        run: |
          echo "üîç Post-Merge Debug"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Commit ID: ${{ github.event.head_commit.id }}"

      - name: Post deployment message
        run: |
          echo "‚úÖ Deployment to production initiated"
          echo "Commit: ${{ github.event.head_commit.id }}"
          echo "Author: ${{ github.event.head_commit.author.name }}"
          echo "Message: ${{ github.event.head_commit.message }}"
          echo "Timestamp: $(date)"
